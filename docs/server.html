<!DOCTYPE html>  <html> <head>   <title>server.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               server.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @author Jonnie Spratley, AppMatrix</span>
<span class="cm"> * @created 02/26/13</span>
<span class="cm"> */</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Configuration Object to hold settings for server</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">:</span> <span class="s1">&#39;passbookmanager&#39;</span><span class="p">,</span>
    <span class="nx">message</span> <span class="o">:</span> <span class="s1">&#39;Passbook Manager API Server&#39;</span><span class="p">,</span>
    <span class="nx">version</span> <span class="o">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span>
    <span class="nx">security</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">salt</span> <span class="o">:</span> <span class="s1">&#39;a58e325c6df628d07a18b673a3420986&#39;</span>
    <span class="p">},</span>
    <span class="nx">server</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">host</span> <span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="nx">port</span> <span class="o">:</span> <span class="mi">4040</span>
    <span class="p">},</span>
    <span class="nx">db</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">username</span> <span class="o">:</span> <span class="s1">&#39;amadmin&#39;</span><span class="p">,</span>
        <span class="nx">password</span> <span class="o">:</span> <span class="s1">&#39;fred&#39;</span><span class="p">,</span>
        <span class="nx">host</span> <span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
        <span class="nx">port</span> <span class="o">:</span> <span class="mi">27017</span>
    <span class="p">},</span>
    <span class="nx">collections</span> <span class="o">:</span> <span class="p">[</span><span class="s1">&#39;devices&#39;</span><span class="p">,</span> <span class="s1">&#39;passes&#39;</span><span class="p">,</span> <span class="s1">&#39;notifications&#39;</span><span class="p">,</span> <span class="s1">&#39;settings&#39;</span><span class="p">],</span>
    <span class="nx">staticDir</span> <span class="o">:</span> <span class="s1">&#39;./app&#39;</span><span class="p">,</span>
    <span class="nx">publicDir</span> <span class="o">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/www&#39;</span><span class="p">,</span>
    <span class="nx">uploadsTmpDir</span> <span class="o">:</span> <span class="s1">&#39;./temp&#39;</span><span class="p">,</span>
    <span class="nx">uploadsDestDir</span> <span class="o">:</span> <span class="s1">&#39;./app/files/uploads&#39;</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h2>Dependencies</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">mongo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mongodb&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Server</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Db</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BSON</span> <span class="o">=</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">BSONPure</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">qs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;querystring&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>REST Resource</h2>

<p>This is the resource object that contains all of the REST api methods for a full CRUD on a mongo account document.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">RestResource</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">useversion</span> <span class="o">:</span> <span class="s1">&#39;v1&#39;</span><span class="p">,</span>
    <span class="nx">name</span> <span class="o">:</span> <span class="s1">&#39;passbookmanager&#39;</span><span class="p">,</span>
    <span class="nx">databaseName</span> <span class="o">:</span> <span class="s1">&#39;passbookmanager&#39;</span><span class="p">,</span>
    <span class="nx">urls</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">v1</span> <span class="o">:</span> <span class="s1">&#39;/api/v1&#39;</span><span class="p">,</span>
        <span class="nx">v2</span> <span class="o">:</span> <span class="s1">&#39;/api/v2/&#39;</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Configuration object from above, to hold settings</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">config</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">server</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">db</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">mongoServer</span> <span class="o">:</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span>
    <span class="nx">mongoDb</span> <span class="o">:</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">,</span>
    <span class="nx">bson</span> <span class="o">:</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">BSONPure</span><span class="p">,</span>
    <span class="nx">host</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span>
    <span class="nx">port</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span>
    <span class="cm">/**</span>
<span class="cm">     * I am the example schema for this resources.</span>
<span class="cm">     */</span>
    <span class="nx">schema</span> <span class="o">:</span> <span class="p">{</span>
        <span class="nx">id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">appid</span> <span class="o">:</span> <span class="s1">&#39;com.domain.app&#39;</span><span class="p">,</span>
        <span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;This is the title&#39;</span><span class="p">,</span>
        <span class="nx">body</span> <span class="o">:</span> <span class="s1">&#39;This is the body.&#39;</span><span class="p">,</span>
        <span class="nx">created</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
        <span class="nx">modified</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span>
    <span class="p">},</span>
    <span class="cm">/**</span>
<span class="cm">     * I enable logging or not.</span>
<span class="cm">     */</span>
    <span class="nx">debug</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="cm">/**</span>
<span class="cm">     * I am the interal logger.</span>
<span class="cm">     */</span>
    <span class="nx">log</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Init the resource applying the config object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">init</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">config</span> <span class="o">=</span> <span class="nx">config</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Server</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">auto_reconnect</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">safe</span> <span class="o">:</span> <span class="kc">false</span>
        <span class="p">});</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Db</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">server</span><span class="p">);</span>
        <span class="cm">/**</span>
<span class="cm">         * Open the database and check for collection, if none</span>
<span class="cm">         * then create it with the schema.</span>
<span class="cm">         */</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Connected to &#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">databaseName</span><span class="p">);</span>
                <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span>
                    <span class="nx">safe</span> <span class="o">:</span> <span class="kc">true</span>
                <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;The collection doesnt exist. creating it with sample data...&#39;</span><span class="p">);</span>
                        <span class="nx">self</span><span class="p">.</span><span class="nx">populateDb</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>index()</h3>

<p>Display default message on index </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">index</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
            <span class="nx">message</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39; -  &#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span>
        <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>collections()</h3>

<p>Display list of default collections </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">collections</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
            <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39; -  &#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
            <span class="nx">results</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">collections</span>
        <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>get()</h3>

<p>Fetch all records.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">get</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span> <span class="o">:</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Providing an id overwrites giving a query in the URL</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">query</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">BSON</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
            <span class="p">};</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Pass a appid param to get all records for that appid</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;appid&#39;</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">query</span><span class="p">[</span><span class="s1">&#39;appid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">String</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;appid&#39;</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Test array of legal query params</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">test</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;limit&#39;</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="s1">&#39;skip&#39;</span><span class="p">,</span> <span class="s1">&#39;hint&#39;</span><span class="p">,</span> <span class="s1">&#39;explain&#39;</span><span class="p">,</span> <span class="s1">&#39;snapshot&#39;</span><span class="p">,</span> <span class="s1">&#39;timeout&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>loop and test</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="p">(</span><span class="nx">o</span> <span class="k">in</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">test</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">options</span><span class="p">[</span><span class="nx">o</span><span class="p">]</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">[</span><span class="nx">o</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Log for interal usage</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="nx">query</span><span class="p">,</span> <span class="s1">&#39;options&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>new database instance</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">auto_reconnect</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">safe</span> <span class="o">:</span> <span class="kc">true</span>
        <span class="p">}));</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>open database</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>prep collection</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>query</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">cursor</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">cursor</span><span class="p">.</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
                                <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="nx">docs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">result</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">flavorize</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;out&quot;</span><span class="p">);</span>
                                        <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                                        <span class="nx">res</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                        <span class="nx">res</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;Not found&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>res.send(404);</p>             </td>             <td class="code">               <div class="highlight"><pre>                                    <span class="p">}</span>
                                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                    <span class="nx">docs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">doc</span><span class="p">);</span>
                                    <span class="p">});</span>
                                    <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                                    <span class="nx">res</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
                                <span class="p">}</span>
                                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                            <span class="p">}</span>
                        <span class="p">});</span>
                    <span class="p">});</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>add()</h3>

<p>Handle saving a document to the database.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">add</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">auto_reconnect</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">safe</span> <span class="o">:</span> <span class="kc">true</span>
            <span class="p">}));</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">collection</span><span class="p">.</span><span class="nx">count</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">count</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;There are &quot;</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="s2">&quot; records.&quot;</span><span class="p">);</span>
                        <span class="p">});</span>
                    <span class="p">});</span>
                    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">[];</span>
                    <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Check if the posted data is an array, if it is, then loop and insert each document</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>insert all docs</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                                <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
                                <span class="p">});</span>
                            <span class="p">}</span>
                            <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>res.header('Location', '/'+req.params.db+'/'+req.params.collection+'/'+docs[0]._id.toHexString());</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                            <span class="nx">res</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
                                <span class="nx">results</span> <span class="o">:</span> <span class="nx">results</span>
                            <span class="p">});</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">docs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">_id</span><span class="p">.</span><span class="nx">toHexString</span><span class="p">());</span>
                                <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;{&quot;ok&quot;:1}&#39;</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
                                <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                            <span class="p">});</span>
                        <span class="p">}</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;{&quot;ok&quot;:0}&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h3>edit()</h3>

<p>Handle updating a document in the database.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">edit</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">BSON</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;auto_reconnect&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="s1">&#39;safe&#39;</span> <span class="o">:</span> <span class="kc">true</span>
        <span class="p">}));</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">collection</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;{&quot;ok&quot;:1}&#39;</span><span class="p">);</span>
                    <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h3>view()</h3>

<p>Handle fetching associated documents for document detail view.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">view</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">},</span>
    </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>populateDb()</h3>

<p>I populate the document db with the schema.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">populateDb</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">collection</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">schema</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">safe</span> <span class="o">:</span> <span class="kc">true</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">self</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
    
    
    <span class="nx">dbStatus</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;get db status&#39;</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="cm">/**</span>
<span class="cm">     * I find all of the records</span>
<span class="cm">     * @param {Object} req</span>
<span class="cm">     * @param {Object} res</span>
<span class="cm">     */</span>
    <span class="nx">findAll</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">RestResource</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">toArray</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">items</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">RestResource</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span> <span class="o">+</span> <span class="s1">&#39;:findAll - &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">items</span><span class="p">));</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">items</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="cm">/**</span>
<span class="cm">     * I find one of the records by id.</span>
<span class="cm">     * @param {Object} req</span>
<span class="cm">     * @param {Object} res</span>
<span class="cm">     */</span>
    <span class="nx">findById</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">RestResource</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;:findById - &#39;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">);</span>
        <span class="nx">RestResource</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">RestResource</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">collection</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
                <span class="s1">&#39;_id&#39;</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">BSON</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">item</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">},</span>
    <span class="nx">destroy</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">_id</span> <span class="o">:</span> <span class="k">new</span> <span class="nx">BSON</span><span class="p">.</span><span class="nx">ObjectID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Delete by id &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Db</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="k">new</span> <span class="nx">mongo</span><span class="p">.</span><span class="nx">Server</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">auto_reconnect</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">safe</span> <span class="o">:</span> <span class="kc">true</span>
        <span class="p">}));</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">collection</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">collection</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;found &#39;</span><span class="p">,</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">collectionName</span><span class="p">,</span> <span class="nx">params</span><span class="p">);</span>
                <span class="nx">collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">docs</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/json&#39;</span><span class="p">);</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;{&quot;ok&quot;:1}&#39;</span><span class="p">);</span>
                        <span class="nx">db</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>readFile()</h3>

<p>Get file contents from a file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">getFile</span> <span class="p">(</span><span class="nx">localPath</span><span class="p">,</span> <span class="nx">mimeType</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">localPath</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">contents</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
                <span class="s2">&quot;Content-Type&quot;</span> <span class="o">:</span> <span class="nx">mimeType</span><span class="p">,</span>
                <span class="s2">&quot;Content-Length&quot;</span> <span class="o">:</span> <span class="nx">contents</span><span class="p">.</span><span class="nx">length</span>
            <span class="p">});</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">contents</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h3>writeFile()</h3>

<p>Write contents to a file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">writeFile</span> <span class="p">(</span><span class="nx">localPath</span><span class="p">,</span> <span class="nx">contents</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>create a stream, and create the file if it doesn't exist</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">stream</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="nx">localPath</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;writeFile&#39;</span><span class="p">,</span> <span class="nx">localPath</span><span class="p">);</span>
    <span class="nx">stream</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>write to and close the stream at the same time</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">stream</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">contents</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">localPath</span><span class="p">,</span> <span class="nx">contents</span><span class="o">:</span> <span class="nx">contents</span><span class="p">});</span>
    <span class="p">});</span>
<span class="p">};</span>




<span class="cm">/**</span>
<span class="cm"> * Command Server for executing build commands from the Web app.</span>
<span class="cm"> */</span>
<span class="kd">var</span> <span class="nx">sys</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sys&#39;</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">exec</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">exec</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">child</span><span class="p">;</span>




<span class="nx">app</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">({</span>
        <span class="nx">keepExtensions</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">uploadDir</span> <span class="o">:</span> <span class="s1">&#39;./app/files/uploads&#39;</span>
    <span class="p">}));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">staticDir</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">directory</span><span class="p">(</span><span class="s1">&#39;./app&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="s1">&#39;dev&#39;</span><span class="p">));</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;jsonp callback&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Something broke!&#39;</span><span class="p">);</span>
    <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>simple logger</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;%s %s&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
<span class="p">});</span>

<span class="cm">/* ======================[ @TODO: Listen for Device registration token ]====================== */</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>onError()</h3>

<p>callback handler</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">onError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">note</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error is: %s&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Note &#39;</span> <span class="o">+</span> <span class="nx">note</span><span class="p">);</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Test device tokens</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">deviceTokens</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;54563ea0fa550571c6ea228880c8c2c1e65914aa67489c38592838b8bfafba2a&#39;</span><span class="p">,</span> <span class="s1">&#39;d46ba7d730f8536209e589a3abe205b055d66d8a52642fd566ee454d0363d3f3&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>API Endpoint</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nx">body</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Execute command - http://localhost:4040/api/v1/cmd/ls</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;cmd&#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="s1">&#39;:command&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">child</span> <span class="o">=</span> <span class="nx">exec</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">command</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">stdout</span><span class="p">,</span> <span class="nx">stderr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">results</span><span class="p">.</span><span class="nx">stdout</span> <span class="o">=</span> <span class="nx">stdout</span><span class="p">;</span>    
        <span class="nx">sys</span><span class="p">.</span><span class="nx">print</span><span class="p">(</span><span class="s1">&#39;stdout: &#39;</span> <span class="o">+</span> <span class="nx">stdout</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">error</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;exec error: &#39;</span> <span class="o">+</span> <span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
            <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
            <span class="nx">results</span><span class="o">:</span> <span class="nx">results</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>API Version Endpoint - http://localhost:3535/smartpass/v1</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Register Pass Endpoint</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/devices/:deviceLibraryIdentifier/registrations/:passTypeIdentifier/:serialNumber&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Logging Endpoint</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/log&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Unregister Pass</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="k">delete</span> <span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/devices/:deviceLibraryIdentifier/:passTypeIdentifier/:serialNumber&#39;</span><span class="p">,</span>
<span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Register device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="s1">&#39;Delete device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="p">});</span>

<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Register device</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/register/:token&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Register device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="s1">&#39;Register device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Get serial numbers</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/devices/:deviceLibraryIdentifier/registrations/:passTypeIdentifier&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Push to device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
        <span class="nx">message</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="s1">&#39;Push to device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Get latest version of pass</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/passes/:passTypeIdentifier/:serialNumber&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Push to device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Send push to device</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/push/:token&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Push to device &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">));</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Initialize the REST resource server with our configuration object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">RestResource</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <ul>
<li>REST METHODS:
*</li>
<li>HTTP     METHOD          URL</li>
<li>======|==============|==============================================</li>
<li>GET      findAll         http://localhost:4040/passbookmanager</li>
<li>GET      findById        http://localhost:4040/passbookmanager/passes/:id</li>
<li>POST     add             http://localhost:4040/passbookmanager/passes</li>
<li>PUT      update          http://localhost:4040/passbookmanager/passes/:id</li>
<li>DELETE   destroy         http://localhost:4040/passbookmanager/passes/:id</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">collections</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/:db/:collection/:id?&#39;</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">findAll</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/:db/:collection/:id?&#39;</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">findById</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/:db/:collection&#39;</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">add</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/:db/:collection/:id&#39;</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">edit</span><span class="p">);</span>
<span class="nx">app</span><span class="p">.</span>
<span class="k">delete</span> <span class="p">(</span><span class="s1">&#39;/api/&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;/:db/:collection/:id&#39;</span><span class="p">,</span> <span class="nx">RestResource</span><span class="p">.</span><span class="nx">destroy</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">message</span> <span class="o">+</span> <span class="s1">&#39; running @&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 