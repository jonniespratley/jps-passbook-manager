<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/controllers/devices-controller.js | Passbook Manager API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/controllers/devices-controller.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
const _ = require(&apos;lodash&apos;);
const assert = require(&apos;assert&apos;);
const Registration = require(&apos;../models/registration&apos;);
const Device = require(&apos;../models/device&apos;);
const Passes = require(&apos;../models/passes&apos;);

module.exports = function(program) {
	var logger = program.getLogger(&apos;controller:devices&apos;);
	return {
		/*
		 # Registration
		 # register a device to receive push notifications for a pass
		 #
		 # POST /v1/devices/&lt;deviceID&gt;/registrations/&lt;typeID&gt;/&lt;serial#&gt;
		 # Header: Authorization: ApplePass &lt;authenticationToken&gt;
		 # JSON payload: { &quot;pushToken&quot; : &lt;push token, which the server needs to send push notifications to this device&gt; }
		 #
		 # Params definition
		 # :device_id      - the device&apos;s identifier
		 # :pass_type_id   - the bundle identifier for a class of passes, sometimes refered to as the pass topic, e.g. pass.com.apple.backtoschoolgift, registered with WWDR
		 # :serial_number  - the pass&apos; serial number
		 # :pushToken      - the value needed for Apple Push Notification service
		 #
		 # server action: if the authentication token is correct, associate the given push token and device identifier with this pass
		 # server response:
		 # --&gt; if registration succeeded: 201
		 # --&gt; if this serial number was already registered for this device: 304
		 # --&gt; if not authorized: 401

		 post &apos;/v1/devices/:device_id/registrations/:pass_type_id/:serial_number&apos;
		 */
		post_device_registration: function(req, res, next) {

			logger(&apos;post_device_registration&apos;, req.url);
			logger(&apos;post_device_registration&apos;, &apos;params&apos;, req.params);
			logger(&apos;post_device_registration&apos;, &apos;Handling registration request...&apos;);

			let device_id = req.params.device_id;
			let pass_type_id = req.params.pass_type_id;
			let serial_number = req.params.serial_number;
			let push_token = req.body.pushToken;
			let authentication_token = req.get(&apos;Authorization&apos;);
			let device = null;
			let registration = null;

			logger(&apos;post_device_registration&apos;, &apos;authentication =&apos;, authentication_token);
			logger(&apos;post_device_registration&apos;, &apos;device_id =&apos;, device_id);
			logger(&apos;post_device_registration&apos;, &apos;pass_type_id =&apos;, pass_type_id);
			logger(&apos;post_device_registration&apos;, &apos;serial_number =&apos;, serial_number);
			logger(&apos;post_device_registration&apos;, &apos;push_token =&apos;, push_token);

			if (!authentication_token) {
				res.status(401).json({
					error: &apos;Unauthorized&apos;
				});
			} else {

				try {
					device = new Device({
						//_id: &apos;device-&apos; + device_id,
						deviceLibraryIdentifier: device_id,
						passTypeIdentifier: pass_type_id,
						authorization: authentication_token,
						pushToken: push_token,
						serialNumber: serial_number
					});

					registration = new Registration({
						//pass_id: serial_number,
						serial_number: serial_number,
						pass_type_id: pass_type_id,
						device_id: device._id,
						auth_token: authentication_token,
						deviceLibraryIdentifier: device_id,
						push_token: push_token
					});

					//# The device has already registered for updates on this pass
					program.db.get(registration._id).then(function(reg) {
						logger(&apos;post_device_registration&apos;, &apos;found&apos;, registration._id);
						logger(&apos;post_device_registration&apos;, &apos;returning 200&apos;);
						res.status(200).json(reg);
					}).catch(function(err) {
						program.db.saveAll([device, registration]).then(function(resp) {
							logger(&apos;post_device_registration&apos;, &apos;inserted&apos;, resp);
							logger(&apos;post_device_registration&apos;, &apos;returning 201&apos;);
							res.status(201).json(resp);
						}).catch(function(err) {
							logger(&apos;post_device_registration&apos;, &apos;error&apos;, err);
							res.status(400).json(err);
						});
					});


				} catch (e) {
					logger(&apos;post_device_registration&apos;, &apos;error&apos;, e);
					//	program.db.saveSync(registration);
					//	program.db.saveSync(device);
					res.status(400).json(e);
				}

			}
		},
		/**
		 * # Unregister
		 #
		 # unregister a device to receive push notifications for a pass
		 #
		 # DELETE /v1/devices/&lt;deviceID&gt;/registrations/&lt;passTypeID&gt;/&lt;serial#&gt;
		 # Header: Authorization: ApplePass &lt;authenticationToken&gt;
		 #
		 # server action: if the authentication token is correct, disassociate the device from this pass
		 # server response:
		 # --&gt; if disassociation succeeded: 200
		 # --&gt; if not authorized: 401
		 * @param req
		 * @param res
		 * @param next
		 */
		delete_device_registration: function(req, res, next) {
			logger(&apos;delete_device_registration&apos;, req.url);

			let authentication_token = `${req.get(&apos;Authorization&apos;)}`;
			let device_id = req.params.device_id;
			let pass_type_id = req.params.pass_type_id;
			let serial_number = req.params.serial_number;

			assert.ok(device_id, &apos;has device id&apos;);
			assert.ok(pass_type_id, &apos;has pass type id&apos;);
			assert.ok(serial_number, &apos;has serial number&apos;);

			let uuid = device_id + &apos;-&apos; + serial_number;
			let registration;

			let device = new Device({
				deviceLibraryIdentifier: device_id
			});

			registration = new Registration({
				serial_number: serial_number,
				auth_token: authentication_token,
				device_id: device._id
			});

			var tokensMatch = false;

			logger(&apos;delete_device_registration&apos;, &apos;req.authenticationToken =&apos;, authentication_token);
			if (!authentication_token) {
				res.status(401).json({
					error: &apos;Unauthorized&apos;
				});
			} else {

				logger(&apos;delete_device_registration&apos;, &apos;Finding registration&apos;, registration._id);

				program.db.get(registration._id).then(function(reg) {
					tokensMatch = (authentication_token === reg.auth_token);

					logger(&apos;delete_device_registration&apos;, &apos;found&apos;, reg._id);
					logger(&apos;delete_device_registration&apos;, &apos;checking tokens&apos;, tokensMatch);

					if (tokensMatch) {

						logger(&apos;delete_device_registration&apos;, &apos;req.authenticationToken =&apos;, authentication_token);
						logger(&apos;delete_device_registration&apos;, &apos;registration token =&apos;, reg.auth_token);
						logger(&apos;delete_device_registration&apos;, &apos;Pass and authentication token match.&apos;);


						program.db.remove(reg._id).then(function(resp) {
							res.status(200).json(resp);

						}).catch(function(err) {
							res.status(404).json({
								error: &apos;Registration does not exist&apos;
							});
						});

					} else {
						logger(&apos;delete_device_registration&apos;, &apos;Pass and authentication token DO NOT match.&apos;);
						res.status(401).json({
							error: &apos;Pass and authentication do not token match.&apos;
						});
					}

				}).catch(function(err) {
					res.status(404).json({
						error: &apos;Registration does not exist&apos;
					});
				});
			}
		},
		/**
		 *

		 # Updatable passes
		 #
		 # get all serial #s associated with a device for passes that need an update
		 # Optionally with a query limiter to scope the last update since
		 #
		 # GET /v1/devices/&lt;deviceID&gt;/registrations/&lt;typeID&gt;
		 # GET /v1/devices/&lt;deviceID&gt;/registrations/&lt;typeID&gt;?passesUpdatedSince=&lt;tag&gt;
		 #
		 # server action: figure out which passes associated with this device have been modified since the supplied tag (if no tag provided, all associated serial #s)
		 # server response:
		 # --&gt; if there are matching passes: 200, with JSON payload: { &quot;lastUpdated&quot; : &lt;new tag&gt;, &quot;serialNumbers&quot; : [ &lt;array of serial #s&gt; ] }
		 # --&gt; if there are no matching passes: 204
		 # --&gt; if unknown device identifier: 404
		 #
		 #
		 * @param req
		 * @param res
		 * @param next
		 */
		get_device_passes: function(req, res, next) {
			let authentication_token = req.get(&apos;Authorization&apos;);
			let device_id = req.params.device_id;
			let pass_type_id = req.params.pass_type_id;
			let serials = [];
			//	let serial_number = req.params.serial_number;

			assert(device_id, &apos;has device id&apos;);
			assert(pass_type_id, &apos;has pass type id&apos;);

			logger(&apos;get_device_passes&apos;, authentication_token);
			logger(&apos;get_device_passes&apos;, req.method, req.url);

			if (!authentication_token) {
				res.status(401).json({
					error: &apos;Unauthorized&apos;
				});

			} else {

				logger(&apos;get_device_passes&apos;, &apos;Make sure device is registered&apos;);
				program.db.find({
					passTypeIdentifier: pass_type_id,
					authorization: authentication_token,
					deviceLibraryIdentifier: device_id
				}).then(function(devices) {

					if (devices) {

						serials = _.pluck(devices, &apos;serialNumber&apos;);

						logger(&apos;get_device_passes&apos;, &apos;get passes by pass_type_id&apos;);
						logger(&apos;get_device_passes&apos;, &apos;Return matching passes&apos;);

						res.status(200).json({
							lastUpdated: Date.now().toString(),
							serialNumbers: serials
						});
					} else {
						res.status(404).json({
							error: &apos;Device not registered&apos;
						});
					}
				}).catch(function(err) {
					res.status(404).json(err);
				});


			}
		}
	};
};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
