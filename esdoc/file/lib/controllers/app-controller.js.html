<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/controllers/app-controller.js | Passbook Manager API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/controllers/app-controller.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

const multipart = require(&apos;connect-multiparty&apos;);
const bodyParser = require(&apos;body-parser&apos;);
const path = require(&apos;path&apos;);
const fs = require(&apos;fs-extra&apos;);
const assert = require(&apos;assert&apos;);
const _ = require(&apos;lodash&apos;);


module.exports = function(program) {
	const config = program.config.defaults;
	const logger = program.getLogger(&apos;AppController&apos;);
  let AppController = {};

	AppController.index = function(req, res, next){
		res.status(200).json({
			message: config.name
		});
	};

	/**
	 * I handle displaying an upload form.
	 * @param req
	 * @param res
	 * @param next
     */
	AppController.get_upload = function(req, res, next){
		res.writeHead(200, {
			&apos;content-type&apos;: &apos;text/html&apos;
		});
		res.end(
			&apos;&lt;form action=&quot;&quot; enctype=&quot;multipart/form-data&quot; method=&quot;post&quot;&gt;&apos; +
			&apos;&lt;input type=&quot;file&quot; name=&quot;files&quot; multiple=&quot;multiple&quot;&gt;&lt;br&gt;&apos; +
				//		&apos;&lt;input type=&quot;file&quot; name=&quot;file&quot;&gt;&lt;br&gt;&apos; +
			&apos;&lt;input type=&quot;submit&quot; value=&quot;Upload&quot;&gt;&apos; +
			&apos;&lt;/form&gt;&apos;
		);
	};

	/**
	 * I handle processing a file upload.
	 * @param req
	 * @param res
	 * @param next
     */
	AppController.post_upload = function(req, res, next){
		var out = [];
		var files = [];
		var file = null;
		var toFilename;

			logger(&apos;upload&apos;, req.files);

			// parse a file upload
			files = req.files;
			for (var f in files) {
				file = files[f];
				logger(&apos;upload&apos;, &apos;file&apos;, file);
				toFilename = path.resolve(config.dataPath, &apos;./passes/&apos; + req.body._id + &apos;.raw/&apos; + file.originalFilename);

				try {
					//	fs.writeFileSync(toFilename, fs.readFileSync(file.path));
					fs.copySync(file.path, toFilename);
					out.push(toFilename);
					logger(&apos;upload&apos;, &apos;to&apos;, toFilename);
					fs.removeSync(file.path);

				} catch (err) {
					console.error(&apos;Oh no, there was an error: &apos; + err.message);
					res.status(400).json({
						error: err.message
					});
				}


			}
			res.status(200).json(out);


	};

	AppController.post_log = function(req, res, next){
		var dataLog = {};
		dataLog._id = _.uniqueId(&apos;log-&apos;);
		dataLog.docType = &apos;log&apos;;
		dataLog.data = req.body;
		dataLog.created_at = _.now();

		_.defer(function() {
			program.db.put(dataLog).then(function(resp) {
				res.status(200).json(resp);
			}).catch(function(err) {
				res.status(400).json(err);
			});
		}, 250);
	};

  return AppController;

};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
