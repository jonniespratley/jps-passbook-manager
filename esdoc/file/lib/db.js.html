<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/db.js | Passbook Manager API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/db.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

var logger = require(&apos;debug&apos;)(&apos;jps-passbook-manager:store&apos;);
var instance = null;
var _ = require(&apos;lodash&apos;);
var Store = require(&apos;jfs&apos;);

function FileDataStore(name, options) {
	//logger(&apos;new FileDataStore&apos;, name, options)
	var db = new Store(name, options || {
			saveId: &apos;_key&apos;,
			//	type: &apos;single&apos;,
			pretty: true
		});
	var _ds = {
		getUUID: function (prefix) {
			return prefix || &apos;doc-&apos; + require(&apos;node-uuid&apos;).v4();
		},
		findBy: function (params) {
			logger(&apos;findBy&apos;, params);
			return this.find(params).then(function (resp) {
				return _(resp).first();
			});
		},

		find: function (params) {
			let self = this;
			logger(&apos;find&apos;, params);
			return new Promise(function (resolve, reject) {
				let _out, _docs = [];

				self.allDocs(params).then(function (resp) {
					_out = _.where(resp.rows, params);

					if (_out &amp;&amp; _out.length &gt; 0) {
						logger(&apos;find.success&apos;, _out.length);
						resolve(_out);
					} else {
						/*TODO - Never reject, just return empty */
						reject({
							error: &apos;No match found&apos;,
							params: params
						});
					}

				});
			});
		},
		allDocs: function (params) {
			return new Promise(function (resolve, reject) {
				let _docs = [], _obj;
				logger(&apos;allDocs&apos;, params);
				_.defer(function () {
					db.all(function (err, objs) {
						if (err) {
							reject(err);
						}
						for (_obj in objs) {
							_docs.push(objs[_obj]);
						}
						if (params) {
							_docs = _.filter(_docs, params);
						}
						resolve({
							rows: _docs
						});
					});
				});
			});
		},
		put: function (doc, id) {
			logger(&apos;put&apos;, doc._id);
			return new Promise(function (resolve, reject) {
				_.defer(function () {
					db.save(doc._id || id, doc, function (err) {
						if (err) {
							logger(&apos;put.error&apos;, err);
							reject(err);
						} else {
							logger(&apos;put.success&apos;, doc._id);
							resolve(doc);
						}

					});
				});
			});
		},
		post: function (doc) {
			doc._id = this.getUUID();
			logger(&apos;post&apos;, doc);
			return new Promise(function (resolve, reject) {
				_.defer(function () {
					db.save(doc, function (err) {
						if (err) {
							logger(&apos;post.error&apos;, err);
							reject(err);
						} else {
							logger(&apos;post.success&apos;, doc._id);
							resolve(doc);
						}
					});
				});
			});
		},
		remove: function (id) {
			logger(&apos;remove&apos;, id);
			return new Promise(function (resolve, reject) {
				_.defer(function () {
					db.delete(id, function (err) {
						if (err) {
							logger(&apos;remove.error&apos;, err);
							reject(err);
						} else {
							logger(&apos;remove.success&apos;, id);
							resolve(id);
						}
					});
				});
			});
		},
		get: function (id) {
			logger(&apos;get&apos;, id);
			return new Promise(function (resolve, reject) {
				_.defer(function () {
					db.get(id, function (err, obj) {
						if (err) {
							logger(&apos;get.error&apos;, err);
							reject(err);
						} else {
							logger(&apos;get.success&apos;, id);
							resolve(obj);
						}
					});
				});
			});
		},
		saveAll: function (docs) {
			let self = this;
			return new Promise(function (resolve, reject) {
				let saves = [];

				let _done = _.after(docs.length, function () {
					logger(&apos;saveAll.success&apos;);
					resolve(saves);
				});
				logger(&apos;saveAll&apos;, docs.length);

				_.forEach(docs, function (doc) {
					doc._id = doc._id || self.getUUID();
					self.put(doc).then(function (resp) {
						logger(&apos;put.success&apos;, resp._id);
						saves.push(resp);
						_done();
					}).catch(function (err) {
						_done(err);
					});
				});
			});
		}
	};
	_ds.saveSync = db.saveSync;
	_ds.allSync = db.allSync;
	_ds.getSync = db.getSync;

	_ds.bulkDocs = _ds.saveAll;
	_ds.findOne = _ds.findBy;

	instance = _ds;

	return instance;
}

module.exports.getInstance = function () {
	if (instance) {
		return instance;
	} else {
		return new FileDataStore();
	}
};

exports.FileDataStore = FileDataStore;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
