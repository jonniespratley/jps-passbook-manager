<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">specs/routes-spec.js | Passbook Manager API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">specs/routes-spec.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;
var assert = require(&apos;assert&apos;),
	path = require(&apos;path&apos;),
	fs = require(&apos;fs-extra&apos;),
	request = require(&apos;supertest&apos;),
	express = require(&apos;express&apos;),
	os = require(&apos;os&apos;);


//Test vars
var testPassName = &apos;Test_Pass_&apos;;
var testPassDir = path.resolve(__dirname, &apos;../../.tmp/&apos;);

var app = express();
var passes;

// TODO: Program
var mocks = require(path.resolve(__dirname, &apos;../helpers/mocks&apos;));
var program = mocks.program;
var db = program.db;
var config = program.config.defaults;

//Test Instances

var mockDevice = mocks.mockDevice;
var mockPass = mocks.mockPass;

var mockIdentifer = {
	passTypeIdentifier: &apos;pass.io.passbookmanager&apos;,
	wwdr: path.resolve(__dirname, &apos;../../certificates/wwdr-authority.pem&apos;),
	p12: path.resolve(__dirname, &apos;../../certificates/pass.io.passbookmanager.p12&apos;),
	passphrase: &apos;fred&apos;
};

var jpsPassbook = require(path.resolve(__dirname, &apos;..&apos; + path.sep + &apos;..&apos; + path.sep + &apos;routes&apos; + path.sep +
	&apos;jps-passbook-routes&apos;))(program, app);

describe(&apos;routes&apos;, function() {

	it(&apos;GET - /api/v1 - should return api&apos;, function(done) {
		request(app)
			.get(&apos;/api/v1&apos;)
			.expect(&apos;Content-Type&apos;, /json/)
			.expect(200, done);
	});



	describe(&apos;PassKit Web Service&apos;, function() {

		beforeEach(function() {
			//console.log(&apos;Using Device&apos;, mockDevice);
			//console.log(&apos;Using Pass&apos;, mockPass);
		});

		describe(&apos;Devices&apos;, function() {
			it(
				&apos;POST - /api/v1/devices/:device_id/registrations/:pass_type_id/:serial_number - register a new device for pass&apos;,
				function(done) {
					request(app)
						.post(
							//&apos;/api/v1/devices/012345678987654321/registrations/pass.jsapps.io/012345678987654321&apos;
							`/api/v1/devices/${mockDevice.deviceLibraryIdentifier}/registrations/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}`
						)
						.send({
							pushToken: mockDevice.pushToken
						})
						.set(&apos;Authorization&apos;, mockDevice.authorization)
						.expect(&apos;Content-Type&apos;, /json/)
						.expect(201, done);
				});

			it(
				&apos;POST - /api/v1/devices/:device_id/registrations/:pass_type_id/:serial_number - return existing device for pass&apos;,
				function(done) {
					request(app)
						.post(
							//&apos;/api/v1/devices/012345678987654321/registrations/pass.jsapps.io/012345678987654321&apos;
							`/api/v1/devices/${mockDevice.deviceLibraryIdentifier}/registrations/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}`
						)
						.send({
							pushToken: mockDevice.pushToken
						})
						//.set(&apos;Authorization&apos;, &apos;ApplePass &apos; + mockPass.authenticationToken)
						.set(&apos;Authorization&apos;, mockDevice.authorization)
						.expect(&apos;Content-Type&apos;, /json/)
						.expect(200, done);
				});

			it(&apos;GET - /api/v1/devices/:device_id/push/:token - send push to device&apos;, function(done) {
				request(app)
					.get(&apos;/api/v1/devices/&apos; + mockDevice.deviceLibraryIdentifier + &apos;/push/&apos; + mockDevice.token)
					.set(&apos;Authorization&apos;, mockDevice.authorization)
					.expect(&apos;Content-Type&apos;, /json/)
					.expect(200, done);
			});

			it(&apos;GET - /api/v1/devices/:device_id/registrations/:pass_type_id - get serial numbers&apos;,
				function(done) {
					request(app)
						.get(&apos;/api/v1/devices/&apos; + mockDevice.deviceLibraryIdentifier + &apos;/registrations/&apos; + mockPass.passTypeIdentifier)
						.set(&apos;Authorization&apos;, mockDevice.authorization)
						.expect(&apos;Content-Type&apos;, /json/)
						.expect(200, done);
				});

			it(&apos;GET - /api/v1/devices/:device_id/registrations/:pass_type_id?passesUpdatedSince=tag - get serial numbers&apos;,
				function(done) {
					request(app)
						.get(&apos;/api/v1/devices/&apos; + mockDevice.deviceLibraryIdentifier + &apos;/registrations/&apos; + mockPass.passTypeIdentifier +
							&apos;?tag=now&apos;)
						.set(&apos;Authorization&apos;, mockDevice.authorization)
						.expect(&apos;Content-Type&apos;, /json/)
						.expect(200, done);
				});

			it(&apos;GET - /api/v1/devices/:device_id/:registrations/:pass_type_id&apos;, function(done) {
				request(app)
					.get(&apos;/api/v1/devices/&apos; + mockDevice.deviceLibraryIdentifier + &apos;/registrations/&apos; + mockPass.passTypeIdentifier)
					.set(&apos;Authorization&apos;, mockDevice.authorization)
					.expect(&apos;Content-Type&apos;, /json/)
					.expect(function(res) {
						assert.ok(res.body.serialNumbers);
					})
					.expect(200, done);
			});

			it(&apos;DELETE - /api/v1/devices/:device_id/:pass_type_id/:serial_number - un-register device&apos;,
				function(done) {
					request(app)
						.delete(
							`/api/v1/devices/${mockDevice.deviceLibraryIdentifier}/registrations/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}`
						)
						.set(&apos;Authorization&apos;, mockDevice.authorization)
						//.expect(&apos;Content-Type&apos;, /json/)
						.expect(200, done);
				});
		});

		describe(&apos;Logs&apos;, function() {
			it(&apos;POST - /api/v1/log - should store logs&apos;, function(done) {
				this.slow(5000);
				request(app)
					.post(&apos;/api/v1/log&apos;)
					.send({
						logs: [&apos;test log&apos;]
					})
					.expect(&apos;Content-Type&apos;, /json/)
					.expect(200, done);
			});
		});
		describe(&apos;Passes&apos;, function() {

			it(&apos;GET - /api/v1/passes/:pass_type_id/:serial_number - 401&apos;, function(done) {
				request(app)
					.get(`/api/v1/passes/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}111`)
					.expect(401, done);
			});

			it(&apos;GET - /api/v1/passes/:pass_type_id/:serial_number&apos;, function(done) {
				request(app)
					.get(`/api/v1/passes/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}`)
					.set(&apos;Authorization&apos;, mockDevice.authorization)
					//.expect(&apos;Content-Type&apos;, /application\/vnd.apple.pkpass/)
					.expect(200, done);

			});

			it(&apos;GET - /api/v1/passes/:pass_type_id/:serial_number - ?updated since date&apos;, function(done) {
				request(app)
					.get(`/api/v1/passes/${mockPass.passTypeIdentifier}/${mockPass.serialNumber}?updatedSince=` + Date.now())
					.set(&apos;Authorization&apos;, mockDevice.authorization)
					//.expect(&apos;Content-Type&apos;, /application\/vnd.apple.pkpass/)
					.expect(204, done);

			});
		});





	});
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
