<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">specs/jps-passbook-spec.js | Passbook Manager API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">specs/jps-passbook-spec.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">var assert = require(&apos;assert&apos;),
	path = require(&apos;path&apos;),
	_ = require(&apos;lodash&apos;),
	fs = require(&apos;fs-extra&apos;),
	SignPass = require(path.resolve(__dirname, &apos;../../lib/signpass&apos;)),
	Passbook = require(path.resolve(__dirname, &apos;../../lib/jps-passbook&apos;));

var mocks = require(path.resolve(__dirname, &apos;../helpers/mocks&apos;));
var program = mocks.program;
var jpsPassbook = new Passbook(program);

var mockIdentifer = mocks.mockIdentifer;
var mockPass = mocks.mockPass;
var mockPasses = mocks.mockPasses;
var _passes = [];
var passFiles = [];

describe(&apos;jps-passbook&apos;, function() {
	describe(&apos;Batching&apos;, function() {
		before(function() {
			program.db.saveAll(mocks.mockPasses).then(function(resp) {
				mockPasses = resp;
				console.log(&apos;GOT PASSES&apos;, resp);
			});
		});

		it(&apos;batchPromise(&quot;create&quot;, passes) - should create each pass in database&apos;, function(done) {
			jpsPassbook.batchPromise(&apos;create&apos;, mockPasses).then(function(_resp) {
				assert(_resp);
				done();
			}).catch(function(err) {
				assert.fail(err);
				done();
			});
		});

		xit(&apos;batchPromise(&quot;sign&quot;, passes) - should create each pass in database&apos;, function(done) {
			this.timeout(20000);
			var mockIds = _.pluck(mockPasses, &apos;_id&apos;);
			console.log(&apos;mockIds&apos;, mockIds);
			jpsPassbook.batchPromise(&apos;sign&apos;, mockPasses).then(function(_resp) {
				console.log(_resp);
				assert(_resp);
				assert(mockIds.length === _resp.length);
				assert(fs.existsSync(p.dest), &apos;returns .pkpass path&apos;);
				done();
			}).catch(function(err) {
				assert.fail(err);
				done();
			});
		});
	});


	describe(&apos;Passes&apos;, function() {

		it(&apos;savePassTypeIdentifier() - should create pass certs and save passTypeIdentifier to database successfully.&apos;,
			function(done) {
				jpsPassbook.savePassTypeIdentifierPromise(mockIdentifer).then(function(p) {
					assert(p);
					done();
				}).catch(function(err) {
					assert.fail(err);
					done();
				});
			});

		it(&apos;savePassTypeIdentifier() - should should fail when no p12 present.&apos;, function(done) {
			jpsPassbook.savePassTypeIdentifierPromise({
				passphrase: &apos;test&apos;,
				passTypeIdentifier: &apos;test&apos;
			}).then(function(p) {
				assert.fail(p);
				done();
			}).catch(function(err) {
				assert(err);
				done();
			});
		});

		it(&apos;savePassTypeIdentifier() - should should fail when no passphrase present.&apos;, function(done) {
			jpsPassbook.savePassTypeIdentifierPromise({
				passTypeIdentifier: &apos;test&apos;
			}).then(function(p) {
				assert.fail(p);
				done();
			}).catch(function(err) {
				assert(err);
				done();
			});
		});

		it(&apos;getPassCerts() - should get pass certs from database successfully.&apos;, function(done) {
			jpsPassbook.getPassCerts(mockPass.passTypeIdentifier, function(err, p) {
				if (err) {
					assert.fail(err);
				}
				assert.ok(p);
				done();
			});
		});

		it(&apos;getPassCerts() - should get pass certs from database fail.&apos;, function(done) {
			jpsPassbook.getPassCerts(&apos;unknown-id&apos;, function(err, p) {
				assert(err);
				done();
			});
		});

		it(&apos;createPassPromise() - should create pass .raw and resolve promise&apos;, function(done) {
			jpsPassbook.createPassPromise(mockPass).then(function(p) {
				assert(fs.existsSync(p.rawFilename), &apos;returns .raw path&apos;);
				done();
			});
		});


		describe(&apos;Signing&apos;, function() {

			before(function(done) {
				program.db.get(mockPass._id).then(function(resp) {
					mockPass = resp;
					//	mockPass = resp[0];
					console.log(&apos;Using Mock Pass&apos;, mockPass);
					done();
				});
			});

			it(&apos;signPass() - should sign .raw package into a .pkpass&apos;, function(done) {
				jpsPassbook.signPass(mockPass, function(err, p) {
					if (err) {
						assert.fail(err);
					}
					assert(fs.existsSync(p.dest), &apos;returns .pkpass path&apos;);
					done();
				});
			});

			it(&apos;signPassPromise() - should sign pass .raw into .pkpass and resolve promise&apos;, function(done) {
				jpsPassbook.signPassPromise(mockPass).then(function(p) {
					assert(fs.existsSync(p.dest), &apos;returns .pkpass path&apos;);
					done();
				});
			});

			describe(&apos;Validation&apos;, function() {
				it(&apos;validatePass() - should validate a pass&apos;, function(done) {
					jpsPassbook.validatePass(mockPass, function(err, p) {
						if (err) {
							assert.fail(err);
						}
						assert(p, &apos;returns pass&apos;);
						//	assert(p.filename, &apos;returns pass filename&apos;);
						assert(fs.existsSync(path.resolve(p.rawFilename, &apos;./manifest.json&apos;)));
						done();
					});
				});

				it(&apos;validatePassPromise() - should validate pass .pkpass signature and resolve promise&apos;, function(done) {
					done();
				});

			});
		});
	});



});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
